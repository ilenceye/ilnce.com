---
import { getCollection } from "astro:content";

import Poster from "@/components/Poster.astro";
import Layout from "@/layouts/Layout.astro";
import { parseWikiLink } from "@/lib/utils";

export const getStaticPaths = async () => {
  const lists = await getCollection("piandan");

  return lists.map((list) => ({
    params: { slug: list.data.slug },
    props: { list },
  }));
};

const { list } = Astro.props;

const watcheds = await getCollection("watched");

const watchedMap = new Map(watcheds.map((entry) => [entry.id, entry]));

const items = list.data.items.map((raw) => {
  const slug = parseWikiLink(raw);
  const watched = watchedMap.get(slug);

  if (!watched) {
    throw new Error(`片单 "${list.id}" 引用了不存在的条目: ${raw} → ${slug}`);
  }

  return watched;
});
---

<Layout title={list.data.title}>
  <section class="space-y-12">
    <h2 class="text-2xl font-bold">
      {list.data.title}
      <span class="text-muted-foreground text-xs">
        {list.data.items.length} 部
      </span>
    </h2>
    <ul class="grid grid-cols-6 gap-6">
      {
        items.map(({ data }) => (
          <li class="grid gap-2">
            <Poster
              src={data.posterUrl}
              alt={data.title}
              width="96px"
              height="144px"
            />
            <div class="text-center text-xs">{data.title}</div>
          </li>
        ))
      }
    </ul>
  </section>
</Layout>
